ilia@ilia-VirtualBox:~/les7$ nano new_iptables.rules 
ilia@ilia-VirtualBox:~/les7$ cat new_iptables.rules 
# Действия по умолчанию
iptables -P INPUT DROP
iptables -P OUTPUT DROP
iptables -P FORWARD DROP

# Разрешаем обмен по локальной петле
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT

# Разрешаем пакеты icmp (для обмена служебной информацией)
iptables -A INPUT -p icmp -j ACCEPT
iptables -A OUTPUT -p icmp -j ACCEPT

# Разрешаем соединения с динамических портов
iptables -A OUTPUT -p TCP -m tcp --sport 32768:61000 -j ACCEPT
iptables -A OUTPUT -p UDP -m udp --sport 32768:61000 -j ACCEPT

# Разрешить только те пакеты, которые мы запросили
iptables -A INPUT -p TCP -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT -p UDP -m state --state ESTABLISHED,RELATED -j ACCEPT

# Но если работаем как сервер SSH, следует разрешить и нужные порты
iptables -A INPUT -i enp0s3 -p tcp -m tcp --dport 22 -j ACCEPT 
iptables -A OUTPUT -o enp0s3 -p tcp -m tcp --sport 22 -j ACCEPT

# task 3
# Разрешить подключения только на 22-й и 80-й порты
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# task 4. Настроить проброс портов локально с порта 80 на порт 8080
# Включить переадресацию трафика на уровне ядра
sysctl -w net.ipv4.ip_forward=1

# Разрешить транзитный трафик
iptables -A FORWARD -j ACCEPT

# Организовать проброс портов входящего трафика с 80-го порта нашего сервера
# на порт 8080 нашего сервера
iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8080

ilia@ilia-VirtualBox:~/les7$ sudo ./new_iptables.rules 
net.ipv4.ip_forward = 1
ilia@ilia-VirtualBox:~/les7$ sudo iptables -L
Chain INPUT (policy DROP)
target     prot opt source               destination         
ACCEPT     all  --  anywhere             anywhere            
ACCEPT     icmp --  anywhere             anywhere            
ACCEPT     tcp  --  anywhere             anywhere             state RELATED,ESTABLISHED
ACCEPT     udp  --  anywhere             anywhere             state RELATED,ESTABLISHED
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:ssh
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:http
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:ssh
ACCEPT     all  --  anywhere             anywhere            
ACCEPT     icmp --  anywhere             anywhere            
ACCEPT     tcp  --  anywhere             anywhere             state RELATED,ESTABLISHED
ACCEPT     udp  --  anywhere             anywhere             state RELATED,ESTABLISHED
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:ssh
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:http
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:ssh

Chain FORWARD (policy DROP)
target     prot opt source               destination         
ACCEPT     all  --  anywhere             anywhere            

Chain OUTPUT (policy DROP)
target     prot opt source               destination         
ACCEPT     all  --  anywhere             anywhere            
ACCEPT     icmp --  anywhere             anywhere            
ACCEPT     tcp  --  anywhere             anywhere             tcp spts:32768:61000
ACCEPT     udp  --  anywhere             anywhere             udp spts:32768:61000
ACCEPT     tcp  --  anywhere             anywhere             tcp spt:ssh
ACCEPT     all  --  anywhere             anywhere            
ACCEPT     icmp --  anywhere             anywhere            
ACCEPT     tcp  --  anywhere             anywhere             tcp spts:32768:61000
ACCEPT     udp  --  anywhere             anywhere             udp spts:32768:61000
ACCEPT     tcp  --  anywhere             anywhere             tcp spt:ssh
ilia@ilia-VirtualBox:~/les7$ sudo iptables -t nat -L
Chain PREROUTING (policy ACCEPT)
target     prot opt source               destination         
REDIRECT   tcp  --  anywhere             anywhere             tcp dpt:http redir ports 8080

Chain INPUT (policy ACCEPT)
target     prot opt source               destination         

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         

Chain POSTROUTING (policy ACCEPT)
target     prot opt source               destination         
ilia@ilia-VirtualBox:~/les7$ sudo iptables-save > iptables.rules 
ilia@ilia-VirtualBox:~/les7$ cat iptables.rules 
# Generated by iptables-save v1.8.4 on Fri Dec  4 13:01:49 2020
*nat
:PREROUTING ACCEPT [579:66069]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [4:318]
:POSTROUTING ACCEPT [4:318]
-A PREROUTING -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 8080
COMMIT
# Completed on Fri Dec  4 13:01:49 2020
# Generated by iptables-save v1.8.4 on Fri Dec  4 13:01:49 2020
*filter
:INPUT DROP [579:66069]
:FORWARD DROP [0:0]
:OUTPUT DROP [0:0]
-A INPUT -i lo -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -p tcp -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p udp -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -i enp0s3 -p tcp -m tcp --dport 22 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 22 -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -p tcp -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p udp -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -i enp0s3 -p tcp -m tcp --dport 22 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 22 -j ACCEPT
-A FORWARD -j ACCEPT
-A OUTPUT -o lo -j ACCEPT
-A OUTPUT -p icmp -j ACCEPT
-A OUTPUT -p tcp -m tcp --sport 32768:61000 -j ACCEPT
-A OUTPUT -p udp -m udp --sport 32768:61000 -j ACCEPT
-A OUTPUT -o enp0s3 -p tcp -m tcp --sport 22 -j ACCEPT
-A OUTPUT -o lo -j ACCEPT
-A OUTPUT -p icmp -j ACCEPT
-A OUTPUT -p tcp -m tcp --sport 32768:61000 -j ACCEPT
-A OUTPUT -p udp -m udp --sport 32768:61000 -j ACCEPT
-A OUTPUT -o enp0s3 -p tcp -m tcp --sport 22 -j ACCEPT
COMMIT
# Completed on Fri Dec  4 13:01:49 2020
